{% macro component() %}
<v-card>
    <v-card-title>
        <v-treeview dense open-on-click :items="permissions"></v-treeview>
    </v-card-title>
    <v-text-field v-model="search" append-icon="mdi-magnify" label="Search" single-line hide-details></v-text-field>
    <v-data-table :headers="roles" :items="users" :items-per-page="500" multi-sort :search="search">
        <template v-slot:item="{ item }">
            <tr>
                <td v-for="(value, name) in item">
                    <v-simple-checkbox readonly color="info" :value="value" v-if="typeof value  == 'boolean'"
                        @click="flipRole(item.userId , name, value)">
                    </v-simple-checkbox>
                    <v-chip v-else>${item.userId}</v-chip>
                </td>
            </tr>
        </template>
    </v-data-table>
</v-card>
{% endmacro %}
{% macro script() %}
<script>
    Vue.component('admin-userRole-form', {
        data: () => ({
            users: [],
            roles: [],
            permissions: [],
            search: ""
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.roleQuery', listRolePermission=True) }}", {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        if (body.permissions) {
                            this.roles = [{
                                    text: "UserId",
                                    value: 'userId'
                                }, ...body.permissions
                                .map(p => {
                                    return {
                                        text: p.role,
                                        value: p.role
                                    }
                                })
                            ]
                            this.permissions = body.permissions.map(p => {
                                return {
                                    name: p.role,
                                    children: Object.keys(p)
                                        .map(k => {
                                            return {
                                                name: k + ' : ' + p[k]
                                            }
                                        })
                                }
                            })
                            fetch("{{ url_for('RESTful.roleQuery', listUser=True ) }}", {
                                    method: 'GET',
                                    cache: 'no-store',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                })
                                .then(response => {
                                    try {
                                        return response.json()
                                    } catch {
                                        this.$root.progress.show = false
                                        this.$root.errorDisplay({},
                                            'Unexpected error occured.')
                                    }
                                })
                                .then(body => {
                                    this.$root.progress.show = false
                                    if (body.users) {
                                        this.users = body.users.map(u => {
                                            user_row = {
                                                userId: u.user.userId
                                            }
                                            this.permissions.forEach(element => {
                                                user_row[element.name] = u.roles
                                                    .includes(element.name)
                                            });
                                            return user_row
                                        })
                                    } else {
                                        this.$root.errorDisplay(body,
                                            'Unexpected error on getting user information.')
                                    }
                                })

                        } else {
                            this.$root.errorDisplay(body, 'Unexpected error on getting role information.')
                        }
                    })
            },
            flipRole(userId, role, value) {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.role') }}" + userId, {
                        method: value ? "DELETE" : "PUT",
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            role: role
                        })
                    })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        this.$root.responseSnackBar(body, 'Unexpected error on setting role assignment.',
                            this.loadData)
                    })
            }
        },
        template: '#adminUserRole',
        created: function () {
            this.loadData()
        },
        delimiters: ['${', '}'],
    })
</script>
{% endmacro %}