{% macro component() %}
<v-card>
    <v-treeview dense open-on-click :items="permissions"></v-treeview>
    <v-data-table :headers="roles" :items="users" :items-per-page="500">
        <template v-slot:item="{ item }">
            <v-simple-checkbox readonly :value="item" v-if="typeof item  == 'boolean'">
            </v-simple-checkbox>
            <v-chip v-else>${item}</v-chip>
        </template>
    </v-data-table>
</v-card>
{% endmacro %}
{% macro script() %}
<script>
    Vue.component('admin-userRole-form', {
        data: () => ({
            users: [],
            roles: [],
            permissions: []
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.listPermission') }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => {
                        return response.json()
                    })
                    .then(permissions => {
                        if (permissions) {
                            this.roles = [{ Text: "UserId", value: 'userId' }, ...permissions
                                .map(p => { return { Text: p.role, value: p.role } })]
                            this.permissions = permissions.map(p => {
                                return {
                                    name: p.role, children: Object.keys(p)
                                        .map(k => { return { name: k + ' : ' + p[k] } })
                                }
                            })
                            fetch("{{ url_for('RESTful.listUserPermission') }}", {
                                method: 'GET',
                                cache: 'no-store',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                            })
                                .then(response => {
                                    return response.json()
                                })
                                .then(users => {
                                    this.$root.progress.show = false
                                    if (users) {
                                        console.log(users)
                                        this.users = users.map(u => {
                                            user_row = { userId: u.user.userId }
                                            this.permissions.forEach(element => {
                                                user_row[element.name] = u.roles.includes(element.name)
                                            });
                                            return user_row
                                        })
                                        console.log(this.users)
                                        console.log(this.roles)
                                    }
                                    else {
                                        if (body.message) {
                                            this.errorSnackBar.message = body.message
                                            this.errorSnackBar.show = true
                                        }
                                        else {
                                            this.errorSnackBar.message = 'Unexpected error on getting user information.'
                                            this.errorSnackBar.show = true
                                        }
                                    }
                                })

                        }
                        else {
                            if (body.message) {
                                this.errorSnackBar.message = body.message
                                this.errorSnackBar.show = true
                            }
                            else {
                                this.errorSnackBar.message = 'Unexpected error on getting role information.'
                                this.errorSnackBar.show = true
                            }
                        }
                    })
            }
        },
        template: '#adminUserRole',
        created: function () {
            this.loadData()
        }
    })
</script>
{% endmacro %}