{% extends "layout.html" %}
{% import 'layout.html' as layout %}
{% block VueComponent %}
<div>
    <v-dialog v-model="instructorDialogue" max-width="500px">
        <v-card v-if="course">
            <v-card-title>Instructors for ${course.courseName}</v-card-title>
            <v-card-text>
                <v-subheader>Assigned</v-subheader>
                <v-chip @click="unassign(user.userId)" v-for="user in instructors" v-if="user.isAssigned"
                    close-icon="file_download">
                    ${user.userId}
                    <v-icon right>file_download</v-icon>
                </v-chip>
            </v-card-text>
            <v-card-text>
                <v-subheader>Not assigned</v-subheader>
                <v-chip @click="assign(user.userId)" v-for="user in instructors" v-if="!user.isAssigned"
                    close-icon="upload">
                    ${user.userId}
                    <v-icon right>upload</v-icon>
                </v-chip>
            </v-card-text>
        </v-card>
    </v-dialog>
    <v-container>
        <v-row v-for="row in rows">
            <v-col v-for="col in row" cols="3" class="d-flex" style="flex-direction:column">
                <v-menu bottom right offset-x v-if="col.courseCode" direction="right" open-on-hover max-width="36">
                    <template v-slot:activator="{ on, attrs }">
                        <v-card v-bind="attrs" v-on="on">
                            <v-card-title>
                                ${col.courseCode}
                            </v-card-title>
                            <v-card-subtitle>
                                <v-avatar size="96">
                                    <img :src="col.img">
                                </v-avatar>
                                ${col.courseName}
                            </v-card-subtitle>
                        </v-card>
                    </template>
                    <v-tooltip bottom>
                        <template v-slot:activator="{ on, attrs }">
                            <v-btn v-bind="attrs" v-on="on" @click="courseTrunk(col.courseCode)" icon>
                                <v-icon>account_tree</v-icon>
                            </v-btn>
                        </template>
                        <span>Versions</span>
                    </v-tooltip>
                    <v-tooltip bottom>
                        <template v-slot:activator="{ on, attrs }">
                            <v-btn v-bind="attrs" v-on="on" @click="courseAssignment(col)" icon>
                                <v-icon>assignment_ind</v-icon>
                            </v-btn>
                        </template>
                        <span>Assign Instructor</span>
                    </v-tooltip>
                </v-menu>
            </v-col>
        </v-row>
    </v-container>
</div>
{% endblock %}
{% block VueComponentScript %}
<script>
    Vue.component('app-content', {
        data: () => ({
            rows: [
                []
            ],
            course: null,
            instructors: null,
            instructorDialogue: false,
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.course.query', list=True) }}", {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        let colPerRow = 4
                        if (body.courses) {
                            body.courses.forEach(c => {
                                let lastRow = this.rows[this.rows.length - 1]
                                if (lastRow.length == colPerRow) {
                                    this.rows.push([])
                                    lastRow = this.rows[this.rows.length - 1]
                                }
                                lastRow.push({
                                    courseCode: c.concept.name,
                                    img: c.course.imageURL,
                                    courseName: c.course.displayName
                                })

                            })
                            let lastRow = this.rows[this.rows.length - 1]
                            while (lastRow.length < colPerRow) {
                                lastRow.push({})
                            }
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting relationship information.')
                        }
                    })
            },
            courseTrunk(courseCode) {
                window.location.replace("{{ url_for('DLTC.versionTree') }}/" + courseCode)
            },
            courseAssignment(course) {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                this.course = course
                fetch("{{ url_for('RESTful.course.query', instructor=True) }}&courseCode=" + course
                        .courseCode, {
                            method: 'GET',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.instructors) {
                            this.instructors = body.instructors
                            this.instructorDialogue = true

                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting instructor assignment information.')
                        }

                    })
            },
            assign(userId) {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.course.patch') }}" + this.course
                        .courseCode, {
                            method: 'PATCH',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: userId,
                                assignment: true
                            })
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        this.$root.responseSnackBar(body,
                            'Assignment failed for unkown reason.',
                            () => {
                                this.courseAssignment(this.course)
                            })

                    })
            },
            unassign(userId) {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.course.patch') }}" + this.course
                        .courseCode, {
                            method: 'PATCH',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: userId,
                                assignment: false
                            })
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        this.$root.responseSnackBar(body,
                            'Assignment failed for unkown reason.',
                            () => {
                                this.courseAssignment(this.course)
                            })

                    })
            }
        },
        mounted: function () {
            this.loadData()
        },
        template: '#content',
        delimiters: ['${', '}'],
    })
</script>
{% endblock %}