{% extends "layout.html" %}
{% import 'layout.html' as layout with context %}
{% block VueComponent %}
<div>
    <v-container id="app">
        <v-row>
            <v-col>
                <v-card-title>
                    {{ courseCode }}<br>
                    course plan
                </v-card-title>
            </v-col>
            <v-col v-show="graph">
                <v-card-text>
                    <v-btn v-show="workspace == null || graph?.deltaGraphId != workspace?.deltaGraphId" small text
                        :href="'{{url_for('instructor.workspace')}}' + graph?.deltaGraphId">open exposed
                        graph in ${workspace?'another':'the'} editor<v-icon>open_in_new</v-icon>
                    </v-btn>
                </v-card-text>
            </v-col>
            <v-col>
                <v-card-subtitle>
                    ${changes?changes+' unsave changes':''}
                    <v-icon v-if="changes">sync</v-icon>
                    ${details == null?'right-click on item for details' :''}
                </v-card-subtitle>
            </v-col>
        </v-row>
        <v-row>
            <v-col cols="auto">
                <v-btn @click="constructTimetable(triples,[],true)">recompute</v-btn>
            </v-col>
            <v-col cols="auto" v-if="preview">
                <v-btn color="success" @click="submitTable()">submit</v-btn>
            </v-col>
            <v-col cols="auto" v-if="preview">
                <v-btn color="error" @click="loadData()">undo</v-btn>
            </v-col>
        </v-row>
        <v-row>
            <v-col>

            </v-col>
            <v-col cols="auto">
                <kcube-schedule-item root v-if="tree" :node="tree" @showDetails="showDetails($event[0],$event[1])"
                    @change="changes += $event">
                </kcube-schedule-item>
            </v-col>
            <v-col>

            </v-col>
        </v-row>
    </v-container>
    <v-menu v-model="showMenu" :position-x="x" :position-y="y" absolute offset-y>
        <v-card>
            <v-card-title>
                Entity ID: ${ details?.name }
            </v-card-title>
            <v-card-subtitle>
                description: ${ details?.desc }
            </v-card-subtitle>
            <v-card-actions>
                <v-btn text color="primary" v-if="inIframe" @click="postMessage('open-entity', details, '*')">
                    open entity editor
                </v-btn>
            </v-card-actions>
        </v-card>
    </v-menu>
</div>
{% endblock %}

{% block VueComponentScript %}
<script type="text/x-template" id="kcube-schedule-item">
<v-card style="float:left" @dragstart.self="dragging=true" @dragend.self="dragging=false" :data-name="node.name"
    :data-desc="node.desc" @dragleave="showAction = false;collapseWeeks($event)"
    @contextmenu.stop="$emit('showDetails',[$event,node])">
    <v-list-item v-if="!root" v-show="!showAction"  @dragover="showAction = dragging?false:true">
        <v-icon small class="handle">drag_indicator</v-icon>
        <v-text-field background-color="transparent" dense hide-details flat solo v-model="node.desc"
            @change="patchEntity(node)"></v-text-field>
    </v-list-item>
    <v-list-item v-if="!root" v-show="showAction" @dragover="expandWeeks($event)" >
        <v-icon small>add</v-icon>
        <v-text-field background-color="transparent" dense hide-details flat solo v-model="node.desc" disabled
            @change="patchEntity(node)"></v-text-field>
    </v-list-item>
    <v-row v-for="week in weeks" v-show="!dragging">
        <v-col cols="auto">
            <v-list-item style="padding:unset" dense>week ${week + 1} </v-list-item>
        </v-col>
        <v-col>
            <draggable v-model="node.schedule[week]" :key="keys[week]" :group="{name:'schedule', put: true}" handle=".handle" @add="add($event, week)" @change="render($event)"
                @remove="remove($event, week)" :style="draggableStyle" animation="200" swapThreshold="0.6">
                    <kcube-schedule-item v-for="child of node.schedule[week]" :node="child"  :key="child.name"@showDetails="$emit('showDetails',$event)" @change="$emit('change',$event)" >
                    </kcube-schedule-item>
            </draggable>
        </v-col>
    </v-row>
</v-card>
</script>
<script>
    Vue.component('kcube-schedule-item', {
        props: {
            node: {
                type: Object,
                required: true
            },
            root: Boolean
        },
        watch: {
            node: function (newVal, oldVal) {
                this.render()
            }
        },
        computed: {
            draggableStyle() {
                return {
                    height: '100%',
                    background: 'content-box grey',
                    overflow: 'hidden',
                }
            }
        },
        data: () => ({
            parentHovered: false,
            showAction: false,
            dragging: false,
            weeks: [],
            keys: {}
        }),
        methods: {
            add(event, week) {
                let entity = {
                    name: event.item.dataset.name,
                    desc: event.item.dataset.desc,
                    week: week,
                }
                this.patchEntity(entity)
                if (workspaceDeltagraphId)
                    fetch("{{ url_for('RESTful.triple.put') }}" + workspaceDeltagraphId, {
                        method: 'PUT',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            h_name: entity.name,
                            r_name: tree_edge_name,
                            t_name: this.node.name,
                            r_value: true,
                            exclusive_head: true,
                        })
                    })
                        .then(response => {
                            try {
                                return response.json()
                            } catch {
                                this.$root.progress.show = false
                                this.$root.errorDisplay({},
                                    'Unexpected error occured.')
                            }
                        })
                        .then(body => {
                            if (body.triple) {
                                window.parent.postMessage({
                                    message: 'coursePlan-exclusiveHeadTriple',
                                    payload: body.triple
                                }, '*')
                            } else {
                                this.$root.errorDisplay(body,
                                    'Unexpected error when deleted triple.')
                            }
                        })
            },
            remove(event, week) {
                let entity = {
                    name: event.item.dataset.name,
                    desc: event.item.dataset.desc,
                    week: week,
                }
            },
            expandWeeks(event) {
                if (this.weeks.length > 0) {
                    if (this.node.schedule[this.weeks[0]].length > 0 && this.weeks[0] > 0) {
                        this.weeks.unshift(this.weeks[0] - 1)
                        this.node.schedule[this.weeks[0]] = []
                    }
                    if (this.node.schedule[this.weeks[this.weeks.length - 1]].length > 0 && this.weeks[this.weeks.length] < weekInSemester) {
                        this.weeks.push(this.weeks[this.weeks.length - 1] + 1)
                        this.node.schedule[this.weeks[this.weeks.length - 1]] = []
                    }
                }
                else {
                    this.weeks = [0, 1]
                    this.weeks.forEach(week => this.node.schedule[week] = [])
                }

            },
            collapseWeeks(event) {
                for (let i = 0; i < this.weeks.length; i++) {
                    if (this.node.schedule[this.weeks[i]].length > 0) break
                    delete this.node.schedule[this.weeks[i]]
                    this.weeks.shift()
                }
                for (let i = this.weeks.length - 1; i >= 0; i--) {
                    if (this.node.schedule[this.weeks[i]].length > 0) break
                    delete this.node.schedule[this.weeks[i]]
                    this.weeks.pop()
                }

            },
            patchEntity(entity) {
                this.$emit('change', 1)
                fetch(
                    "{{ url_for('RESTful.activity.post', courseCode = courseCode) | safe}}" +
                    encodeURIComponent(
                        entity.name), {
                    method: 'POST',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        desc: entity.desc,
                        week: entity.week + 1
                    })
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activity) {
                            this.$emit('change', -1)
                            try {
                                if (window.self !== window.top) {
                                    throw ''
                                }
                            } catch (e) {
                                window.parent.postMessage({
                                    message: 'update-entity',
                                    payload: entity
                                }, '*')
                            }
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on setting courses plan information.')
                        }
                    })

            },
            render() {
                if (this.node.schedule) {
                    let week = Object.keys(this.node.schedule).filter(week => this.node.schedule[week].length > 0).map(week => Number(week))
                    if (week.length > 0) {
                        let max = Math.max(...week)
                        let min = Math.min(...week)
                        this.weeks = [...Array(max - min + 1).keys()].map(week => week + min)

                    }
                    for (const week in this.weeks) {
                        if (this.node.schedule[week] && this.node.schedule[week].length > 0) {
                            this.keys[week] = this.node.schedule[week].map(node => node.name).join(';')
                        }
                        else {
                            this.keys[week] = ';' + week
                            if (!(week in this.node.schedule)) this.node.schedule[week] = []
                        }
                    }
                }
            }
        },
        mounted: function () {
            this.render()
            this.$nextTick(() =>
                this.node.children.filter(node => node.isAllocatingWeek).forEach(node => this.patchEntity(node)))
        },
        template: '#kcube-schedule-item',
        delimiters: ['${', '}'],
    })
</script>
<style>
    .v-text-field input,
    .v-list-item {
        font-size: small;
    }

    .v-list-item {
        padding: 0 0 0 8px;
    }

    #sortable>div {
        float: left;
    }
</style>
<script>
    let tree_edge_name = "Subtopic in"
    let workspaceDeltagraphId
    let weekInSemester = 13
    Vue.component('app-content', {
        data: () => ({
            tree: null,
            changes: 0,
            x: null,
            y: null,
            details: null,
            showMenu: false,
            inIframe: false,
            preview: false,
            graph: null,
            workspace: null,
        }),

        methods: {
            loadData() {
                this.$root.progress.show = true
                let activityPromise = fetch(
                    "{{ url_for('RESTful.activity.query', ofUser=True, courseCode = courseCode) | safe}}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activities) {
                            return body.activities
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses plan information.')
                        }
                    })
                let graphPromise = fetch(
                    "{{ url_for('RESTful.triple.getCourse', courseCode = courseCode, userId = USER.userId) }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.course && body.triples) {
                            this.graph = body.graph
                            workspaceDeltagraphId = this.graph.deltaGraphId
                            return body.triples
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                return Promise.all([graphPromise, activityPromise]).then(data => {
                    tripleFilter = triple => triple.r_name == tree_edge_name && triple.r_value == true
                    let triples = data[0] ? data[0].filter(tripleFilter) : []
                    let activities = data[1]
                    this.triples = triples
                    this.activities = activities
                    this.constructTimetable(triples, activities)

                })
            },
            constructTimetable(triples, activities, preview = false) {
                function traversal(name) {
                    let activity = activities.filter(a => a.name == name)
                    let node = {
                        name: name,
                        desc: activity.length > 0 ? activity[0].desc : name,
                        week: activity.length > 0 ?
                            (Number.isInteger(Number(activity[0].week)) ? Number(activity[0].week) - 1 : null) : null,
                        children: []
                    }
                    triples = triples.filter(triple => {
                        if (triple.t_name == name) {
                            node.children.push(triple.h_name)
                            return false
                        }
                        return true
                    })
                    node.numItem = 1
                    if (node.children.length == 0) {
                        node.numUnassignedItem = node.week != null ? 0 : 1
                    }
                    else {
                        node.children = node.children.map(child => traversal(child))
                        node.children = node.children.sort((childA, childB) => childB.numItem - childA.numItem)
                        node.numUnassignedItem = node.children.map(child => child.numUnassignedItem).reduce((previous, current) => previous + current)
                        node.numItem = node.children.map(child => child.numItem).reduce((previous, current) => previous + current)

                    }
                    return node
                }
                this.tree = traversal("{{courseCode}}")
                let totalItem = this.tree.numUnassignedItem
                function allocate(node, slot) {
                    if (node.week === null) {
                        node.isAllocatingWeek = true
                        node.week = Math.min(Math.round(slot * weekInSemester), weekInSemester - 1)
                        if (node.children.length == 0) {
                            slot = slot + 1 / totalItem
                        }
                    }
                    node.children.forEach(child => {
                        slot = allocate(child, slot)
                    })
                    node.schedule = node.children.reduce(
                        (previous, child) => {
                            if (previous[child.week]) {
                                previous[child.week].push(child)
                            }
                            else {
                                previous[child.week] = [child]
                            }
                            return previous
                        }, Object.create(null))
                    return slot
                }
                allocate(this.tree, 0)
                function weekify(node) {
                }
                console.log(this.tree)
                //this.plan = assign_timeslot(triples, activities, "{{courseCode}}")
                this.preview = preview
                if (preview) {

                } else {
                    this.submitTable()
                }
            },
            submitTable() {
                this.preview = false
                for (week in this.plan) {
                    for (index in this.plan[week]) {
                        if (this.plan[week][index].week) {

                        } else {
                            this.dropEntity({
                                newIndex: index
                            }, week)
                        }
                    }
                }
            },

            showDetails(event, entity) {
                event.preventDefault()
                this.x = event.clientX
                this.y = event.clientY
                this.details = entity
                this.$nextTick(() => {
                    this.showMenu = true
                })
            },
            postMessage(message, payload, domain) {
                window.parent.postMessage({
                    message: message,
                    payload: payload
                }, domain)

            }
        },
        mounted: function () {
            window.addEventListener('beforeunload', (e) => {
                if (this.changes) {
                    e.preventDefault()
                    e.returnValue = this.changes + 'changes are still uploading';
                }
            });
            try {
                if (window.self !== window.top) {
                    throw ''
                }
            } catch (e) {
                this.inIframe = true
                window.parent.addEventListener('beforeunload', (e) => {
                    if (this.changes) {
                        e.preventDefault()
                        e.returnValue = this.changes + 'changes are still uploading';
                    }
                });
            }
            let loadDataPromise = this.loadData()
            window.onmessage = (e) => {
                if (e.data) {
                    const {
                        message,
                        payload
                    } = e.data

                    if (message == "graphEditor-activity") {
                        for (week in this.plan) {
                            for (index in this.plan[week]) {
                                if (this.plan[week][index].name == payload.name) {
                                    let entity = this.plan[week][index]
                                    entity.desc = payload.desc
                                    entity.week = payload.week
                                    this.plan[week].splice(index, 1)
                                    this.plan[entity.week].push(entity)
                                    this.$nextTick(
                                        () => {
                                            let listEle = document.getElementById('entity:' +
                                                payload.name)
                                            listEle.scrollIntoView({
                                                behavior: "smooth",
                                                block: "center"
                                            })
                                            let ev = new Event("mousedown")
                                            let offset = listEle.getBoundingClientRect()
                                            ev.clientX = offset.left + offset.width / 2
                                            ev.clientY = offset.top + offset.height / 2
                                            listEle.dispatchEvent(ev)
                                            this.$nextTick(function () {
                                                listEle.dispatchEvent(new Event("mouseup"))
                                            })
                                        }
                                    )
                                }
                            }
                        }
                    } else if (message == "graphEditor-workspace") {
                        this.workspace = payload

                    } else if (message == "graphEditor-exposureToggle") {
                        this.loadData()

                    }
                }
            }
            window.parent.postMessage({
                message: 'coursePlan-mount'
            }, '*')
            this.$root.$on('post-activities', function (activities) {

            })

        },
        template: '#content',
        delimiters: ['${', '}'],
    })

    function updateItem(item) {
        app.$emit('post-activity', item)
    }
</script>
{% endblock %}