{% extends "layout.html" %}
{% import 'layout.html' as layout with context %}
{% block VueComponent %}
<v-container id="app">
    <v-row>
        <v-col>
            <v-card-title>
                {{ courseCode }} course plan
            </v-card-title>
        </v-col>
        <v-col>
            <v-card-subtitle>
                ${changes?changes+' unsave changes':''}
                <v-icon v-if="changes">sync</v-icon>
                ${details == null?'right-click on item for details' :''}
            </v-card-subtitle>
        </v-col>
    </v-row>
    <v-row v-bind:style="{borderColor:'black',borderStyle:week % 1 == 0?'solid':(plan[week].length>0?'solid':'dashed solid dashed solid')
    ,borderWidth: week % 1 == 0?
        (week<13?'0 1px 0 1px':'0 1px 1px 1px'):(plan[week].length>0?'1px 1px 0 1px':'1px 1px 1px 1px')}"
        v-for="week in [...Object.keys(plan).sort(function(a,b) { return a - b})]" no-gutters>
        <v-col cols="auto" v-if="week % 1 == 0">
            <v-list-item style="padding:unset" dense>week ${week}</v-list-item>
        </v-col>
        <v-col cols="auto" v-else-if="plan[week].length == 0" style="height: 5px;"></v-col>
        <v-col>
            <draggable style="display: flex;" handle=".handle" v-model="plan[week]" direction="horizontal"
                ghost-class="ghost" group="entity" @add="dropEntity($event, week)">
                <v-list-item v-ripple="{ class: 'primary--text' }" @contextmenu="showDetails($event,entity)"
                    v-for="entity in plan[week]" dense v-bind:id="'entity:'+entity.name">
                    <v-icon small class="handle">drag_handle</v-icon>
                    <v-text-field background-color="transparent" dense hide-details flat solo v-model="entity.desc"
                        @change="patchEntity(entity)">
                    </v-text-field>
                </v-list-item>
            </draggable>
        </v-col>
    </v-row>
    <v-row>
        <v-col cols="auto">
            <v-btn @click="constructTimetable(triples,[],true)">recompute</v-btn>
        </v-col>
        <v-col cols="auto" v-if="preview">
            <v-btn color="success" @click="submitTable()">submit</v-btn>
        </v-col>
        <v-col cols="auto" v-if="preview">
            <v-btn color="error" @click="loadData()">undo</v-btn>
        </v-col>
    </v-row>
    </div>
    <v-menu v-model="showMenu" :position-x="x" :position-y="y" absolute offset-y>
        <v-card>
            <v-card-title>
                Entity ID: ${ details?.name }
            </v-card-title>
            <v-card-subtitle>
                description: ${ details?.desc }
            </v-card-subtitle>
            <v-card-actions>
                <v-btn text color="primary" v-if="inIframe"
                    @click="postMessage({ method: 'open', entity: details }, '*')">
                    open entity editor
                </v-btn>
            </v-card-actions>
        </v-card>
    </v-menu>
</v-container>
{% endblock %}

{% block VueComponentScript %}
<script src="{{ url_for('static', filename='coursePlanScript/index.js')}}"></script>
<style>
    .v-text-field input,
    .v-list-item {
        font-size: small;
    }

    .v-list-item {
        padding: 0 0 0 8px;
    }

    .ghost {
        background-color: lightgrey;
    }
</style>
<script>
    Vue.component('app-content', {
        data: () => ({
            plan: {},
            changes: 0,
            x: null,
            y: null,
            details: null,
            showMenu: false,
            inIframe: false,
            preview: false,
        }),

        methods: {
            loadData() {
                this.$root.progress.show = true
                let activityPromise = fetch(
                    "{{ url_for('RESTful.activity.query', ofUser=True, courseCode = courseCode) | safe}}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activities) {
                            return body.activities
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses plan information.')
                        }
                    })
                let graphPromise = fetch(
                    "{{ url_for('RESTful.triple.getCourse', courseCode = courseCode) }}?editing=true", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.course && body.triples) {
                            return body.triples
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                let departmentGraphPromise = fetch(
                    "{{ url_for('RESTful.triple.getCourse', courseCode = courseCode, userId = None) }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.course && body.triples) {
                            return body.triples
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                Promise.all([graphPromise, departmentGraphPromise, activityPromise]).then(data => {
                    let triples = data[0].filter(triple => triple.r_name == "Subtopic in")
                    if (triples.length == 0) triples = data[1].filter(triple => triple.r_name == "Subtopic in")
                    let activities = data[2]
                    this.triples = triples
                    this.activities = activities
                    this.constructTimetable(triples, activities)

                })
            },
            constructTimetable(triples, activities, preview = false) {
                this.plan = assign_timeslot(triples, activities, "{{courseCode}}")
                this.preview = preview
                if (preview) {

                }
                else {
                    this.submitTable()
                }
            },
            submitTable() {
                this.preview = false
                for (week in this.plan) {
                    for (index in this.plan[week]) {
                        if (this.plan[week][index].week) {

                        }
                        else {
                            this.dropEntity({ newIndex: index }, week)
                        }
                    }
                }
            },
            dropEntity(event, week) {
                let entity = this.plan[week][event.newIndex]
                entity.week = week
                this.patchEntity(entity)
            },
            patchEntity(entity) {
                this.changes++
                fetch(
                    "{{ url_for('RESTful.activity.post', courseCode = courseCode) | safe}}" +
                    encodeURIComponent(
                        entity.name), {
                    method: 'POST',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        desc: entity.desc,
                        week: entity.week
                    })
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activity) {
                            this.changes--
                            try {
                                if (window.self !== window.top) {
                                    throw ''
                                }
                            } catch (e) {
                                window.parent.postMessage({ method: 'update', entity: entity }, '*')
                            }
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on setting courses plan information.')
                        }
                    })

            },
            showDetails(event, entity) {
                event.preventDefault()
                this.x = event.clientX
                this.y = event.clientY
                this.details = entity
                this.$nextTick(() => {
                    this.showMenu = true
                })
            },
            postMessage(messageObject, domain) {
                window.parent.postMessage(messageObject, domain)
            }
        },
        mounted: function () {
            window.addEventListener('beforeunload', (e) => {
                if (this.changes) {
                    e.preventDefault()
                    e.returnValue = this.changes + 'changes are still uploading';
                }
            });
            try {
                if (window.self !== window.top) {
                    throw ''
                }
            } catch (e) {
                this.inIframe = true
                window.parent.addEventListener('beforeunload', (e) => {
                    if (this.changes) {
                        e.preventDefault()
                        e.returnValue = this.changes + 'changes are still uploading';
                    }
                });
            }
            window.onmessage = (e) => {
                if (e.data && e.data.name && e.data.desc && e.data.week) {
                    console.log(e.data)
                    for (week in this.plan) {
                        for (index in this.plan[week]) {
                            if (this.plan[week][index].name == e.data.name) {
                                let entity = this.plan[week][index]
                                entity.desc = e.data.desc
                                entity.week = e.data.week
                                this.plan[week].splice(index, 1)
                                this.plan[entity.week].push(entity)
                                this.$nextTick(
                                    () => {
                                        let listEle = document.getElementById('entity:' + e.data.name)
                                        listEle.scrollIntoView({ behavior: "smooth", block: "center" })
                                        let ev = new Event("mousedown")
                                        let offset = listEle.getBoundingClientRect()
                                        ev.clientX = offset.left + offset.width / 2
                                        ev.clientY = offset.top + offset.height / 2
                                        listEle.dispatchEvent(ev)
                                        this.$nextTick(function () {
                                            listEle.dispatchEvent(new Event("mouseup"))
                                        })
                                    }
                                )
                            }
                        }
                    }
                }

            }
            this.loadData()

            this.$root.$on('post-activities', function (activities) {

            })
        },
        template: '#content',
        delimiters: ['${', '}'],
    })

    function updateItem(item) {
        app.$emit('post-activity', item)
    }
</script>
{% endblock %}