{% extends "layout.html" %}
{% import 'layout.html' as layout with context %}
{% block VueComponent %}
<v-container id="app">
    <v-row>
        <v-spacer></v-spacer>
        <v-col>
            <v-card-title>
                {{ courseCode }} course Plan
            </v-card-title>
            <v-card-subtitle v-if="changes">
                ${changes?changes+' unsave changes':''}
                <v-icon>sync</v-icon>
            </v-card-subtitle>
        </v-col>
        <v-spacer></v-spacer>
    </v-row>
    <v-row v-for="week in [...Object.keys(plan).sort()]">
        <v-col cols="auto" v-if="week % 1 == 0">week ${week}</v-col>
        <v-col>
            <draggable style="display: flex;" handle=".handle" v-model="plan[week]" direction="horizontal"
                group="entity" @add="dropEntity($event, week)">
                <v-btn v-for="entity in plan[week]" small>
                    <v-icon class="handle">drag_handle</v-icon>
                    <v-text-field v-model="entity.desc" @change="patchEntity(entity)"></v-text-field>
                </v-btn>
            </draggable>
        </v-col>
    </v-row>
    <v-row>
        <v-col cols="auto">
            <v-btn @click="constructTimetable(triples,[])">recompute</v-btn>
        </v-col>
    </v-row>
    </div>
</v-container>
{% endblock %}

{% block VueComponentScript %}
<script src="{{ url_for('static', filename='coursePlanScript/index.js')}}"></script>
<script>
    Vue.component('app-content', {
        data: () => ({
            plan: {},
            changes: 0
        }),

        methods: {
            loadData() {
                this.$root.progress.show = true
                let activityPromise = fetch(
                    "{{ url_for('RESTful.activity.query', ofUser=True, courseCode = courseCode) | safe}}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activities) {
                            return body.activities
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses plan information.')
                        }
                    })
                let graphPromise = fetch(
                    "{{ url_for('RESTful.triple.getCourse', courseCode = courseCode, userId = session['user']['userId']) }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.course && body.triples) {
                            return body.triples
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                let departmentGraphPromise = fetch(
                    "{{ url_for('RESTful.triple.getCourse', courseCode = courseCode, userId = None) }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.course && body.triples) {
                            return body.triples
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                Promise.all([graphPromise, departmentGraphPromise, activityPromise]).then(data => {
                    let triples = data[0].filter(triple => triple.r_name == "Subtopic in")
                    if (triples.length == 0) triples = data[1].filter(triple => triple.r_name == "Subtopic in")
                    let activities = data[2]
                    this.triples = triples
                    this.activities = activities
                    this.constructTimetable(triples, activities, "{{courseCode}}")

                })
            },
            constructTimetable(triples, activities) {
                this.plan = assign_timeslot(triples, activities, "{{courseCode}}")
                for (week in this.plan) {
                    for (index in this.plan[week]) {
                        if (this.plan[week][index].week) {

                        }
                        else {
                            this.dropEntity({ newIndex: index }, week)
                        }
                    }
                }
            },
            dropEntity(event, week) {
                let entity = this.plan[week][event.newIndex]
                this.changes++
                fetch(
                    "{{ url_for('RESTful.activity.post', courseCode = courseCode) | safe}}" +
                    encodeURIComponent(
                        entity.name), {
                    method: 'POST',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        desc: entity.desc,
                        week: week
                    })
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activity) {
                            entity.week = week
                            this.changes--
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on setting courses plan information.')
                        }
                    })
            },
            patchEntity(entity) {
                this.changes++
                console.log(entity)
                console.log(entity.name)
                fetch(
                    "{{ url_for('RESTful.activity.post', courseCode = courseCode) | safe}}" +
                    encodeURIComponent(
                        entity.name), {
                    method: 'POST',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        desc: entity.desc,
                        week: entity.week
                    })
                })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.activity) { this.changes-- } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on setting courses plan information.')
                        }
                    })

            }
        },
        mounted: function () {
            window.onmessage = (e) => {
                if (e.data == "loadData") {
                    this.loadData()
                }
            }
            this.loadData()

            this.$root.$on('post-activities', function (activities) {

            })
        },
        template: '#content',
        delimiters: ['${', '}'],
    })

    function updateItem(item) {
        app.$emit('post-activity', item)
    }
</script>
{% endblock %}