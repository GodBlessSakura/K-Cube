{% extends "layout.html" %}
{% import 'layout.html' as layout %}
{% block VueComponent %}
<v-card style="height: 100%; width: 100%;">
    <div id="cy" style="height: 100%; width: 100%;"></div>
    <v-snackbar v-model="showSelectBar" timeout='-1'>
        Select a ${ (snackbarMethod == 'branch')?'a branch or a trunk':'ready branch'} for ${
        (snackbarMethod == 'branch')?'merging':'creation'}
        <template v-slot:action="{ attrs }">
            <v-btn color="blue" text v-bind="attrs" @click="resume()">
                Cancel
            </v-btn>
        </template>
    </v-snackbar>
    <v-menu v-model="showMenu" :position-x="cursor_x" :position-y="cursor_y" absolute>
        <v-list>
            {% if isInstructor %}
            <v-list-item v-if="selectedNodeClasses.includes('branch')" @click="readyToPush()">
                <v-list-item-title>Ready to push</v-list-item-title>
            </v-list-item>
            <v-list-item v-if="selectedNodeClasses.includes('branch')" @click="mergeWithAnother()">
                <v-list-item-title>Merge with another</v-list-item-title>
            </v-list-item>
            <v-list-item v-if="selectedNodeClasses.includes('branch') || selectedNodeClasses.includes('trunk')"
                @click="createWorkspaceDialogue()">
                <v-list-item-title>Create workspace</v-list-item-title>
            </v-list-item>
            <v-list-item v-if="selectedNodeClasses.includes('workspace')" @click="commit()">
                <v-list-item-title>Commit workspace</v-list-item-title>
            </v-list-item>
            {% endif %}
            {% if isDLTC %}
            <v-list-item v-if="selectedNodeClasses.includes('trunk') && !selectedNodeClasses.includes('isActive')"
                @click="setActive()">
                <v-list-item-title>Set as active</v-list-item-title>
            </v-list-item>
            <v-list-item v-if="selectedNodeClasses.includes('trunk')" @click="release()">
                <v-list-item-title>Release new version</v-list-item-title>
            </v-list-item>
            {% endif %}
        </v-list>
    </v-menu>
    {% if isInstructor %}
    <v-dialog v-model="workspaceCreateDialog">
        <v-card>
            <v-card-title class="text-h5 grey lighten-2">
                Give a name tag to your new workspace:
            </v-card-title>
            <v-form ref="createWorkspaceControl">
                <v-text-field label="tag" :rules="tagRules" v-model="tag" required></v-text-field>
            </v-form>
            <v-divider></v-divider>

            <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn color="primary" text @click="createWorkspace()">
                    create
                </v-btn>
            </v-card-actions>
        </v-card>
    </v-dialog>
    {% endif %}
</v-card>
{% endblock %}
{% block VueComponentScript %}
{{ layout.cytoscapeCDN() }}
<script>
    cy = cytoscape({
        style: [{
                selector: 'node',
                style: {
                    'label': 'data(tag)'
                }
            }, {
                selector: 'node.isActive',
                style: {
                    'shape': 'star'
                }
            }, {
                selector: 'node.workspace',
                style: {
                    'shape': 'diamond'
                }
            }, {
                selector: 'node.workspace',
                style: {
                    'shape': 'triangle'
                }
            },
            {
                selector: 'edge',
                style: {
                    'label': 'data(tag)',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                }
            },
            {
                selector: 'node.uselectable',
                style: {
                    'opacity': 0.25
                }
            }, {
                selector: 'node.branch',
                style: {
                    'shape': 'rectangle'
                }
            }, {
                selector: 'node.canPush[]',
                style: {
                    'shape': 'diamond'
                }
            },
        ],
        userZoomingEnabled: false,
        userPanningEnabled: false,
        boxSelectionEnabled: false
    })

    function nodeFactory(node, classes) {
        if (node.isActive) {
            classes.push('isActive')
        }
        if (node.canPatch) {
            classes.push('canPatch')
        }
        if (node.property.canPush) {
            classes.push('canPush')
        }
        let output = {
            group: 'nodes',
            data: {
                id: 'node' + node.id,
                tag: node.property.tag,
                deltaGraphId: node.property.deltaGraphId
            },
            classes: classes,
            position: {
                x: 0,
                y: 0
            },
            grabbable: false,
            pannable: false,
        }
        return output
    }

    function edgeFactory(edge) {
        let output = {
            group: 'edges',
            data: {
                id: 'edge' + edge.id,
                source: 'node' + edge.start,
                target: 'node' + edge.end,
                tag: edge.type
            }
        }
        return output

    }
    Vue.component('app-content', {
        data: () => ({
            showMenu: false,
            cursor_x: undefined,
            cursor_y: undefined,
            showSelectBar: false,
            snackbarMethod: '',
            selectedNodeClasses: [],
            //{% if isInstructor %}
            workspaceCreateDialog: false,
            tag: '',
            tagRules: [v => !!v || 'Tag name is required',
                v => v.length > 3 && v.length < 101 ||
                'Tag name should be anything between 4 and 100 charactors',
                v => /^[a-zA-Z0-9\s.]+$/.test(v) ||
                'Tag name can only contains alphanumeric characters, dot(.) and space.'
            ],
            //{% endif %}
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch(
                        "{{ url_for('RESTful.tree.get', courseCode = courseCode, isInstructor = isInstructor, isDLTC = isDLTC) }}", {
                            method: 'GET',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        if (body.edges && body.trunk_nodes && body.branch_nodes && body.workspace_nodes) {
                            cy.remove(cy.elements())
                            body.trunk_nodes.forEach(node => {
                                cy.add(nodeFactory(node, ["trunk"]))
                            })
                            body.branch_nodes.forEach(node => {
                                cy.add(nodeFactory(node, ["branch"]))
                            })
                            body.workspace_nodes.forEach(node => {
                                cy.add(nodeFactory(node, ["workspace"]))
                            })
                            body.edges.forEach(edge => {
                                cy.add(edgeFactory(edge))
                            })
                            cy.layout({
                                name: 'breadthfirst',
                                fit: true,
                                grid: true,
                                roots: 'node[tag = "init"]',
                                padding: document.documentElement.clientHeight * 0.15
                            }).run()
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting drafts information.')
                        }
                    })
            },
            // {% if isInstructor %}
            readyToPush() {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.branch.patch') }}" + this.selectedNode.data("deltaGraphId"), {
                        method: 'PATCH',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            canPush: true,
                        })
                    })
                    .then(response => {
                        return response.json()
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        this.$root.responseSnackBar(body,
                            'Creation failed for unkown reason.',
                            () => {
                                this.loadData()
                            })
                    })
            },
            mergeWithAnother() {
                this.snackbarMethod = 'branch'
                this.selectableNodes = cy.nodes(
                    '.branch[deltaGraphId  != "' + this.selectedNode.data("deltaGraphId") + '"],' +
                    '.trunk')
                this.selectAnotherMode()
            },
            createWorkspaceDialogue() {
                this.workspaceCreateDialog = true
            },
            createWorkspace() {
                if (this.$refs.createWorkspaceControl.validate()) {
                    if (this.$root.progress.show == true) {
                        this.$root.bePatientSnackBar.show = true
                        return
                    }
                    this.$root.progress.show = true
                    fetch("{{ url_for('RESTful.workspace.put') }}" + this.selectedNode.data("deltaGraphId"), {
                            method: 'PUT',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                tag: this.tag,
                            })
                        })
                        .then(response => {
                            return response.json()
                        })
                        .then(body => {
                            this.$root.progress.show = false
                            this.$root.responseSnackBar(body,
                                'Creation failed for unkown reason.',
                                () => {
                                    this.workspaceCreateDialog = false
                                    this.$refs.createWorkspaceControl.reset()
                                    this.loadData()
                                })
                        })
                }
            },
            commit() {
                this.newTab("{{ url_for('instructor.commit')}}" + this.selectedNode.data("deltaGraphId"))
            },
            // {% endif %}
            // {% if isDLTC %}
            setActive() {
                if (this.$root.progress.show == true) {
                    this.$root.bePatientSnackBar.show = true
                    return
                }
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.trunk.patch') }}" + this.selectedNode.data("deltaGraphId"), {
                        method: 'PATCH',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            active: true,
                        })
                    })
                    .then(response => {
                        return response.json()
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        this.$root.responseSnackBar(body,
                            'Creation failed for unkown reason.',
                            () => {
                                this.loadData()
                            })
                    })
            },
            release() {
                this.snackbarMethod = 'trunk'
                this.selectableNodes = cy.nodes(
                    '.branch.canPush')
                this.selectAnotherMode()
            },
            // {% endif %}
            selectAnotherMode() {
                cy.nodes().difference(this.selectableNodes).addClass('uselectable')
                cy.nodes().unselectify()
                this.showSelectBar = true
            },
            resume() {
                this.showSelectBar = false
                cy.nodes(".uselectable").removeClass('uselectable')
                cy.nodes().unselectify()
            },
            newTab(url) {
                let w = window.open(url, '_blank')
                w.onbeforeunload = () => {
                    this.loadData()
                }
                w.focus()
                this.resume()
            }
        },
        mounted: function () {
            cy.mount(document.getElementById("cy"))
            self = this
            cy.on('cxttapend', (event) => {
                console.log(event)
                if (event.target == event.cy) return
                self.showMenu = true
                self.cursor_x = event.originalEvent.clientX
                self.cursor_y = event.originalEvent.clientY
                this.selectedNode = event.target[0]
                this.selectedNodeClasses = event.target[0].classes()
                event.target[0].select()
            })
            cy.on('tap', 'node', (event) => {
                console.log(event)
                if (event.target == event.cy) return
                if (this.showSelectBar) {
                    // {% if isInstructor %}
                    if (this.snackbarMethod == 'branch') {
                        if (this.selectableNodes.contains(event.target[0])) {
                            this.newTab("{{ url_for('instructor.branch')}}" + event.target[0].data(
                                    'deltaGraphId') + '/' + this
                                .selectedNode.data("deltaGraphId"))
                        }
                    }
                    // {% endif %}
                    // {% if isDLTC %}
                    if (this.snackbarMethod == 'trunk') {
                        if (this.selectableNodes.contains(event.target[0])) {
                            this.newTab("{{ url_for('DLTC.trunk')}}" + event.target[0].data(
                                    'deltaGraphId') + '/' + this
                                .selectedNode.data("deltaGraphId"))
                        }
                    }
                    // {% endif %}
                    return
                }

                if (event.target.classes().includes("trunk")) {
                    this.newTab("127.0.0.1:5000")
                }
                if (event.target.classes().includes("branch")) {
                    this.newTab("127.0.0.1:5000")
                }
                // {% if isInstructor %}
                if (event.target.classes().includes("workspace")) {
                    this.newTab("{{ url_for('instructor.workspace')}}" + event.target.data(
                        "deltaGraphId"))
                }
                // {% endif %}
                // {% if isDLTC %}
                // {% endif %}
            })
            this.loadData()
        },
        template: '#content',
        delimiters: ['${', '}'],
    })
</script>
{% endblock %}