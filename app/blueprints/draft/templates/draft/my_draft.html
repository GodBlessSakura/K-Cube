{% extends "layout.html" %}
{% import 'layout.html' as layout %}
{% block VueComponent %}
<v-card>
    <v-container>
        <v-row>
            <v-expansion-panels>
                <v-expansion-panel>
                    <v-expansion-panel-header>
                        {{ courseCode }}
                    </v-expansion-panel-header>
                    <v-expansion-panel-content>
                        <v-form ref="draftControl">
                            <v-text-field v-model="draftName" :rules="draftNameRules" dense label="Draft Name">
                            </v-text-field>
                        </v-form>
                        <v-btn small @click="submitDraft">
                            submit
                        </v-btn>
                    </v-expansion-panel-content>
                </v-expansion-panel>
            </v-expansion-panels>
        </v-row>
        <v-row>
            <v-text-field v-model="search" append-icon="mdi-magnify" label="Search" single-line hide-details>
            </v-text-field>
        </v-row>
        <v-row>
            <v-data-table :headers="headers" style="width:100%" :items="drafts" :items-per-page="500" multi-sort
                :search="search" @dblclick:row="openGraph">
                <template v-slot:item.creationDate="{ item }">
                    ${item.creationDate}
                </template>
                <template v-slot:item.lastModified="{ item }">
                    ${item.lastModified }
                </template>
            </v-data-table>
        </v-row>
    </v-container>

</v-card>
{% endblock %}
{% block VueComponentScript %}
<script>
    Vue.component('app-content', {
        data: () => ({
            search: '',
            drafts: [],
            headers: [
                {
                    text: 'Draft name',
                    value: 'draftName',
                },
                {
                    text: 'Date of creation',
                    value: 'creationDate',
                },
                {
                    text: 'Date modified',
                    value: 'lastModified',
                },
                {
                    text: 'Status',
                    value: 'status',
                },
            ],
            draftControl: true,
            draftName: '',
            draftNameRules: [v => !!v || 'Draft name is required',
            v => v.length > 3 && v.length < 101 || 'Draft name  should be anything between 4 and 100 charactors',
            v => /^[a-zA-Z0-9\s]+$/.test(v) || 'Draft name  can only contains alphanumeric characters and space.'],
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch("{{ url_for('RESTful.listDraft', courseCode = courseCode) }}", {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => {
                        return response.json()
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        let colPerRow = 4
                        if (body.drafts) {
                            body.drafts.forEach(d => {
                                this.drafts.push(d)
                            })
                        }
                        else {
                            if (body.message) {
                                this.$root.errorSnackBar.message = body.message
                                this.$root.errorSnackBar.show = true
                            }
                            else {
                                this.$root.errorSnackBar.message = 'Unexpected error on getting drafts information.'
                                this.$root.errorSnackBar.show = true
                            }
                        }
                    })
            },
            submitDraft() {
                if (this.$refs.draftControl.validate()) {
                    if (this.$root.progress.show == true) {
                        this.$root.bePatientSnackBar.show = true
                        return
                    }
                    this.$root.progress.show = true
                    fetch("{{ url_for('RESTful.createDraft', courseCode = courseCode) }}", {
                        method: 'POST',
                        cache: 'no-store',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            draftName: this.draftName,
                        })
                    })
                        .then(response => {
                            return response.json()
                        })
                        .then(body => {
                            this.$root.progress.show = false
                            if (body.success) {
                                if (body.message) {
                                    this.$root.completeSnackBar.message = body.message
                                }
                                else {
                                    this.$root.completeSnackBar.message = 'success'
                                }
                                this.$root.completeSnackBar.show = true
                                this.$refs.draftControl.reset();
                            }
                            else {
                                if (body.message) {
                                    this.$root.errorSnackBar.message = body.message
                                    this.$root.errorSnackBar.show = true
                                }
                                else {
                                    this.$root.errorSnackBar.message = 'Creation failed for unkown reason.'
                                    this.$root.errorSnackBar.show = true
                                }
                            }
                        })
                }
            },
            openGraph(windowEvent, clickEvent) {
                window.location.replace("{{ url_for('draft.edit_draft') }}" + '/' + clickEvent.item.draftId)
            },
        },
        created: function () {
            this.loadData()
        },
        template: '#content',
        delimiters: ['${', '}'],
    })
</script>
{% endblock %}