{% extends "layout.html" %}
{% import 'layout.html' as layout %}
{% block VueComponent %}
<v-container>
    <v-row>
        <v-card-title>
            choose a graph provided by:
        </v-card-title>
    </v-row>
    <v-row v-for="row in rows">
        <v-col v-for="col in row" cols="3" class="d-flex" style="flex-direction:column">
            <v-card v-if="col.userName" :href="'{{ url_for('courseGraph', courseCode=courseCode) }}' + (col.userId !=
            null ? '/' + col.userId : '')">
                <v-list-item>
                    <v-list-item-title>
                        ${col.userName}
                    </v-list-item-title>
                    {% if session['user'] and session['user']['userId'] %}
                    <v-divider vertical v-if="workspaceURL && col.userId == '{{session['user']['userId']}}'">
                    </v-divider>
                    <v-tooltip bottom v-if="workspaceURL && col.userId == '{{session['user']['userId']}}'">
                        <template v-slot:activator="{ on, attrs }">
                            <v-list-item-icon style="margin: unset;">
                                <v-btn style="height: 48px;" :href="workspaceURL" v-bind="attrs" v-on="on">
                                    <v-icon>work</v-icon>
                                </v-btn>
                            </v-list-item-icon>
                        </template>
                        Last-visited workspace
                    </v-tooltip>
                    {% endif %}
                </v-list-item>
            </v-card>
        </v-col>
    </v-row>
</v-container>
{% endblock %}
{% block VueComponentScript %}
<script>
    Vue.component('app-content', {
        data: () => ({
            rows: [
                []
            ],
            course: null,
            //{% if session['permission'] and session['permission'].canAccessInstructorPanel %}
            workspaceURL: undefined,
            //{% endif %}
        }),
        methods: {
            loadData() {
                this.$root.progress.show = true
                fetch(
                        "{{ url_for('RESTful.course.query', graphs=True, courseCode = courseCode) | safe }}", {
                            method: 'GET',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        let colPerRow = 4
                        if (body.instructors) {
                            body.instructors.forEach(instructor => {
                                let lastRow = this.rows[this.rows.length - 1]
                                if (lastRow.length == colPerRow) {
                                    this.rows.push([])
                                    lastRow = this.rows[this.rows.length - 1]
                                }
                                lastRow.push(instructor)

                            })
                            let lastRow = this.rows[this.rows.length - 1]
                            if (lastRow.length == colPerRow) {
                                this.rows.push([])
                                lastRow = this.rows[this.rows.length - 1]
                            }
                            lastRow.push({
                                userName: 'department',
                                userId: null
                            })
                            while (lastRow.length < colPerRow) {
                                lastRow.push({})
                            }
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting courses information.')
                        }
                    })
                //{% if session['permission'] and session['permission'].canAccessInstructorPanel %}
                fetch(
                        "{{ url_for('RESTful.workspace.query', lastModified=True, courseCode = courseCode) | safe }}", {
                            method: 'GET',
                            cache: 'no-store',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                    .then(response => {
                        try {
                            return response.json()
                        } catch {
                            this.$root.progress.show = false
                            this.$root.errorDisplay({},
                                'Unexpected error occured.')
                        }
                    })
                    .then(body => {
                        this.$root.progress.show = false
                        let colPerRow = 4
                        if (body.deltaGraphIds) {
                            if (body.deltaGraphIds.length > 0) {
                                this.workspaceURL = "{{ url_for('instructor.workspace')}}" + body
                                    .deltaGraphIds[0]
                            }
                        } else {
                            this.$root.errorDisplay(body,
                                'Unexpected error on getting workspace information.')
                        }
                    })
                //{% endif %}
            },
        },
        mounted: function () {
            this.loadData()
        },
        template: '#content',
        delimiters: ['${', '}'],
    })
</script>
{% endblock %}